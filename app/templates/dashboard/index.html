{% extends "base.html" %}

{% block content %}
<!-- Google Material Symbols & Socket.IO -->
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<div id="mainDashboard"
    class="flex h-screen bg-white dark:bg-[#1a1c1e] overflow-hidden font-inter text-[#3c4043] dark:text-[#e8eaed] opacity-0 transition-opacity duration-700">
    <!-- Sidebar -->
    <aside
        class="w-64 bg-white dark:bg-[#1a1c1e] hidden md:flex flex-col py-6 px-2 border-r border-gray-100 dark:border-gray-800">
        <div class="px-6 mb-10">
            <h1 class="text-2xl font-semibold flex items-center gap-3">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Auralis Logo"
                    class="w-8 h-8 object-contain">
                Auralis
            </h1>
        </div>

        <nav class="flex-grow px-3 space-y-6 overflow-y-auto custom-scrollbar">
            <!-- Communication Section -->
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mb-3">
                    Communication</p>
                <div class="space-y-1">
                    <button onclick="switchTab('meetings')" id="nav-meetings" class="nav-item active-nav">
                        <span class="material-symbols-outlined">calendar_today</span>
                        <span>Meetings</span>
                    </button>
                    <button onclick="switchTab('calls')" id="nav-calls" class="nav-item">
                        <span class="material-symbols-outlined">videocam</span>
                        <span>Calls</span>
                    </button>
                </div>
            </div>

            <!-- Workspace Section -->
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mb-3">
                    Workspace</p>
                <div class="space-y-1">
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item">
                        <span class="material-symbols-outlined">dashboard</span>
                        <span>Dashboard</span>
                    </button>
                    <a href="/tone/" class="nav-item">
                        <span class="material-symbols-outlined">graphic_eq</span>
                        <span>Tone Learning</span>
                    </a>
                </div>
            </div>

            <!-- System Section -->
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-[0.2em] mb-3">
                    System</p>
                <div class="space-y-1">
                    <a href="/settings/" class="nav-item">
                        <span class="material-symbols-outlined">settings</span>
                        <span>Settings</span>
                    </a>
                </div>
            </div>
        </nav>

        <div class="p-4 mt-auto border-t border-gray-100 dark:border-gray-800">
            <button onclick="handleLogout()"
                class="flex items-center w-full px-4 py-3 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-full transition-colors font-medium">
                <span class="material-symbols-outlined mr-4">logout</span>
                Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col overflow-hidden relative bg-white dark:bg-[#1a1c1e]">
        {% include "dashboard/tabs/_overview.html" %}
        {% include "dashboard/tabs/_meetings.html" %}
        {% include "dashboard/tabs/_calls.html" %}
    </main>
</div>

<!-- CREATE MEETING MODAL (Enhanced) -->
<div id="createMeetingModal"
    class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div
        class="bg-white dark:bg-[#202124] rounded-2xl shadow-2xl w-full max-w-md p-8 animate-fade-in border border-gray-100 dark:border-gray-700">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-normal tracking-tight">New Meeting</h3>
            <button onclick="closeCreateMeetingModal()"
                class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center text-gray-400 hover:text-red-500 transition-all">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <form id="createMeetingForm" class="space-y-6">
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-1">Meeting Title</label>
                <input type="text" id="meetingTitleInput" placeholder="e.g. Project Sync" required
                    class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-transparent focus:border-[#1a73e8] focus:ring-1 focus:ring-[#1a73e8] outline-none text-sm transition-all">
            </div>

            <div class="space-y-4">
                <button type="button" onclick="handleMeetCreation('instant')"
                    class="w-full flex items-center gap-4 p-4 rounded-xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all text-left">
                    <span class="material-symbols-outlined text-[#1a73e8]">bolt</span>
                    <div>
                        <p class="text-sm font-semibold">Start an instant meeting</p>
                        <p class="text-xs text-gray-500">Redirect instantly to a video room</p>
                    </div>
                </button>

                <button type="button" onclick="handleMeetCreation('later')"
                    class="w-full flex items-center gap-4 p-4 rounded-xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all text-left">
                    <span class="material-symbols-outlined text-[#1a73e8]">link</span>
                    <div>
                        <p class="text-sm font-semibold">Create a meeting for later</p>
                        <p class="text-xs text-gray-500">Get a link you can share with others</p>
                    </div>
                </button>

                <button type="button" onclick="handleMeetCreation('schedule')"
                    class="w-full flex items-center gap-4 p-4 rounded-xl border border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-all text-left">
                    <span class="material-symbols-outlined text-[#1a73e8]">calendar_month</span>
                    <div>
                        <p class="text-sm font-semibold">Schedule in Google Calendar</p>
                        <p class="text-xs text-gray-500">Open calendar with link pre-filled</p>
                    </div>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- LATER MODAL (Link Display) -->
<div id="laterModal"
    class="hidden fixed inset-0 bg-black/50 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div
        class="bg-white dark:bg-[#202124] rounded-2xl p-8 max-w-sm w-full shadow-2xl relative border border-gray-100 dark:border-gray-700 animate-fade-in text-center">
        <div
            class="w-16 h-16 bg-green-50 dark:bg-green-900/10 rounded-full flex items-center justify-center mx-auto mb-6">
            <span class="material-symbols-outlined text-green-500 text-3xl">check_circle</span>
        </div>
        <h3 class="text-2xl font-normal mb-3">Meeting link ready</h3>
        <p class="text-gray-500 text-sm mb-6">Share this with people you want in the meeting.</p>
        <div
            class="bg-gray-50 dark:bg-gray-800/80 p-5 rounded-xl flex items-center justify-between border border-gray-100 dark:border-gray-800 mb-6">
            <span id="generatedLink"
                class="text-gray-800 dark:text-gray-100 truncate mr-3 text-sm font-semibold">...</span>
            <button onclick="copyGeneratedLink()"
                class="w-10 h-10 bg-white dark:bg-gray-700 rounded-lg flex items-center justify-center text-[#1a73e8] shadow-sm active:scale-90"><span
                    class="material-symbols-outlined text-xl">content_copy</span></button>
        </div>
        <button onclick="closeLaterModal()"
            class="text-sm font-bold text-gray-400 hover:text-gray-600 uppercase tracking-widest">Dismiss</button>
    </div>
</div>

<!-- CALLING MODALS (Direct Calling) -->
<div id="incomingCallModal"
    class="hidden fixed inset-0 bg-black/70 backdrop-blur-lg z-[60] flex items-center justify-center p-4">
    <div
        class="bg-white dark:bg-[#202124] rounded-[2rem] shadow-2xl w-full max-w-sm p-10 animate-fade-in text-center border border-gray-100 dark:border-gray-700">
        <div class="relative w-24 h-24 mx-auto mb-8">
            <div class="absolute inset-0 bg-[#1a73e8] rounded-full animate-ping opacity-20"></div>
            <div class="relative bg-[#1a73e8] rounded-full w-full h-full flex items-center justify-center text-white">
                <span class="material-symbols-outlined text-4xl">person</span>
            </div>
        </div>
        <h3 class="text-2xl font-semibold mb-2" id="callerNameDisplay">Incoming call</h3>
        <div class="flex justify-center gap-6 mt-10">
            <button onclick="declineCall()"
                class="bg-red-500 hover:bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-90"><span
                    class="material-symbols-outlined text-3xl">call_end</span></button>
            <button onclick="acceptCall()"
                class="bg-green-500 hover:bg-green-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg transition-all active:scale-90"><span
                    class="material-symbols-outlined text-3xl">videocam</span></button>
        </div>
    </div>
</div>

<div id="outgoingCallModal"
    class="hidden fixed inset-0 bg-black/70 backdrop-blur-lg z-[60] flex items-center justify-center p-4">
    <div
        class="bg-white dark:bg-[#202124] rounded-[2rem] shadow-2xl w-full max-w-sm p-10 animate-fade-in text-center border border-gray-100 dark:border-gray-700">
        <div class="relative w-24 h-24 mx-auto mb-8">
            <div class="absolute inset-0 bg-[#1a73e8] rounded-full animate-pulse opacity-20"></div>
            <div
                class="relative bg-gray-100 dark:bg-gray-800 rounded-full w-full h-full flex items-center justify-center text-[#1a73e8]">
                <span class="material-symbols-outlined text-4xl">person</span>
            </div>
        </div>
        <h3 class="text-2xl font-semibold mb-2" id="targetNameDisplay">Calling...</h3>
        <p class="text-gray-500 mb-10 ring-text">Ringing...</p>
        <button onclick="cancelCall()"
            class="bg-red-500 hover:bg-red-600 text-white w-16 h-16 mx-auto rounded-full flex items-center justify-center shadow-lg transition-all active:scale-90"><span
                class="material-symbols-outlined text-3xl">call_end</span></button>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal"
    class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4">
    <div
        class="bg-white dark:bg-[#202124] rounded-2xl shadow-2xl w-full max-w-md p-8 border border-gray-100 dark:border-gray-700">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-normal tracking-tight">Upload Meeting</h3>
            <button onclick="document.getElementById('uploadModal').classList.add('hidden')"
                class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center text-gray-400 hover:text-red-500 transition-all"><span
                    class="material-symbols-outlined">close</span></button>
        </div>
        <form id="uploadForm" class="space-y-6">
            <div class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl p-12 text-center hover:border-[#1a73e8] cursor-pointer"
                onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" name="file" class="hidden" accept=".txt,.pdf,.wav,.mp3">
                <span class="material-symbols-outlined text-4xl text-gray-300 mb-3">upload_file</span>
                <p class="text-sm font-medium">Click to upload meeting file</p>
                <p id="fileName" class="text-xs text-[#1a73e8] mt-4 font-bold truncate px-6"></p>
            </div>
            <button type="submit"
                class="w-full bg-[#1a73e8] hover:bg-[#1557b0] text-white font-bold py-4 rounded-xl shadow-xl transition-all">Start
                Processing</button>
        </form>
    </div>
</div>

<style>
    body {
        font-family: 'Inter', sans-serif;
        letter-spacing: -0.01em;
    }

    .nav-item {
        @apply flex items-center gap-4 px-4 py-3 text-[#5f6368] dark:text-[#bdc1c6] font-medium transition-all w-full text-left rounded-xl;
        font-size: 14px;
    }

    .nav-item:hover {
        @apply bg-gray-100 dark:bg-gray-800 text-[#202124] dark:text-white;
    }

    .active-nav {
        @apply text-[#1a73e8] bg-[#e8f0fe] dark:bg-[#1a73e8]/10 font-bold;
    }

    .active-nav span.material-symbols-outlined {
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    @keyframes fade-in {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fade-in 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
    }

    .ring-text {
        animation: pulse 1s infinite alternate;
    }

    @keyframes pulse {
        from {
            opacity: 0.5;
        }

        to {
            opacity: 1;
        }
    }
</style>

<script>
    checkAuth();
    document.getElementById('mainDashboard').classList.remove('opacity-0');

    // --- DOM REFERENCES ---
    const codeInput = document.getElementById('meetCodeInput');
    const joinBtn = document.getElementById('btnJoinCode');

    if (codeInput) {
        codeInput.addEventListener('input', () => {
            const val = codeInput.value.trim();
            joinBtn.disabled = !val;
            if (val) {
                joinBtn.classList.add('text-[#1a73e8]');
                joinBtn.classList.remove('text-gray-400');
            } else {
                joinBtn.classList.remove('text-[#1a73e8]');
                joinBtn.classList.add('text-gray-400');
            }
        });
        codeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') joinByCode(); });
    }

    // --- SOCKET.IO & AUTH ---
    const socket = io();
    const currentUser = JSON.parse(localStorage.getItem('auralis_user')) || { name: 'User' };

    if (currentUser) {
        document.getElementById('displayUserNameOverview').textContent = currentUser.name;
        socket.emit('register_session', { user_id: currentUser.id || 'anonymous' });
    }

    // --- TAB NAVIGATION ---
    function switchTab(tab) {
        ['dashboard', 'meetings', 'calls'].forEach(t => {
            const el = document.getElementById('tab-' + t);
            const nav = document.getElementById('nav-' + t);
            if (el) el.classList.add('hidden');
            if (nav) nav.classList.remove('active-nav');
        });
        const activeTab = document.getElementById('tab-' + tab);
        const activeNav = document.getElementById('nav-' + tab);
        if (activeTab) activeTab.classList.remove('hidden');
        if (activeNav) activeNav.classList.add('active-nav');

        if (tab === 'dashboard') loadOverviewData();
        if (tab === 'calls') loadRecentCalls();
    }

    // --- MEETING CREATION ---
    function openCreateMeetingModal() { document.getElementById('createMeetingModal').classList.remove('hidden'); }
    function closeCreateMeetingModal() { document.getElementById('createMeetingModal').classList.add('hidden'); }

    async function handleMeetCreation(type) {
        const title = document.getElementById('meetingTitleInput').value.trim();
        if (!title) { alert('Please enter a title'); return; }

        if (type === 'schedule') {
            const res = await apiCall('/meet/create', 'POST', { title, type: 'later' });
            const meetUrl = window.location.origin + res.url;
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent('Join Auralis Meeting: ' + meetUrl)}`;
            window.open(calendarUrl, '_blank');
            closeCreateMeetingModal();
            return;
        }

        try {
            const res = await apiCall('/meet/create', 'POST', { title, type });
            closeCreateMeetingModal();
            if (type === 'instant') window.location.href = res.url;
            else {
                document.getElementById('generatedLink').textContent = window.location.host + res.url;
                document.getElementById('laterModal').classList.remove('hidden');
                loadOverviewData();
            }
        } catch (err) { alert('Failed to create meeting.'); }
    }

    // --- DATA LOADING (OVERVIEW) ---
    async function loadOverviewData() {
        try {
            // First load regular meetings
            const meetings = await apiCall('/meetings/');
            const historyList = document.getElementById('meetingsListOverview');
            if (historyList) {
                historyList.innerHTML = meetings.map(m => `
                    <div class="bg-white dark:bg-[#202124] rounded-xl p-6 border border-gray-100 dark:border-gray-800 hover:shadow-md transition-all cursor-pointer group" onclick="window.location.href='/meet/${m.meeting_id}'">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[10px] uppercase font-bold px-2 py-1 rounded bg-[#1a73e8]/10 text-[#1a73e8]">${m.status}</span>
                            <span class="text-[10px] text-gray-400 font-medium">${new Date(m.created_at).toLocaleDateString()}</span>
                        </div>
                        <h4 class="text-base font-semibold truncate">${m.title || 'Meeting'}</h4>
                        <p class="text-xs text-gray-400 mt-2">Code: ${m.meeting_id}</p>
                    </div>
                `).join('');
            }
            document.getElementById('totalMeetingsCount').textContent = meetings.length;

            // Fetch specific upcoming count
            const upcoming = meetings.filter(m => m.status === 'scheduled');
            document.getElementById('upcomingMeetingsCount').textContent = upcoming.length;

        } catch (e) { console.error('Load overview error:', e); }
    }

    // --- CALLING LOGIC & SEARCH ---
    let activeCallData = null;
    socket.on('receiving_call', (data) => {
        activeCallData = data;
        document.getElementById('callerNameDisplay').textContent = data.caller_name;
        document.getElementById('incomingCallModal').classList.remove('hidden');
    });

    socket.on('call_accepted', (data) => {
        document.getElementById('outgoingCallModal').classList.add('hidden');
        window.location.href = `/meet/${data.meeting_id}`;
    });

    socket.on('call_declined', () => { alert('Call declined.'); document.getElementById('outgoingCallModal').classList.add('hidden'); });

    function acceptCall() {
        socket.emit('accept_call', { caller_id: activeCallData.caller_id, meeting_id: activeCallData.meeting_id });
        window.location.href = `/meet/${activeCallData.meeting_id}`;
    }
    function declineCall() {
        socket.emit('decline_call', { caller_id: activeCallData.caller_id });
        document.getElementById('incomingCallModal').classList.add('hidden');
    }
    function cancelCall() { document.getElementById('outgoingCallModal').classList.add('hidden'); }

    let searchTimeout;
    async function handleUserSearch() {
        const query = document.getElementById('userSearchInput').value.trim();
        const resultsEl = document.getElementById('searchResults');
        if (query.length < 2) { resultsEl.innerHTML = ''; return; }
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            try {
                const res = await apiCall(`/auth/search_users?q=${query}`);
                resultsEl.innerHTML = res.map(u => `
                    <div class="flex items-center justify-between p-4 bg-white dark:bg-[#202124] rounded-xl border border-gray-100 dark:border-gray-800 hover:shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-[#1a73e8]/10 rounded-full flex items-center justify-center text-[#1a73e8] font-bold">${u.name.charAt(0)}</div>
                            <div><h4 class="font-semibold text-sm">${u.name}</h4><p class="text-xs text-gray-400">${u.email}</p></div>
                        </div>
                        <button onclick="initiateCall('${u.id}', '${u.name}')" class="bg-[#1a73e8] hover:bg-[#1557b0] text-white px-5 py-2 rounded-full text-xs font-bold transition-all uppercase tracking-wider">Call</button>
                    </div>
                `).join('');
                if (!res.length) resultsEl.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">No contacts found.</p>';
            } catch (e) { }
        }, 300);
    }

    async function initiateCall(targetId, targetName) {
        document.getElementById('targetNameDisplay').textContent = targetName;
        document.getElementById('outgoingCallModal').classList.remove('hidden');
        try {
            const res = await apiCall('/meet/create', 'POST', { title: `Call with ${targetName}`, type: 'instant' });
            socket.emit('initiate_call', { target_user_id: targetId, caller_name: currentUser.name, caller_id: currentUser.id, meeting_id: res.meetingId });
        } catch (e) { document.getElementById('outgoingCallModal').classList.add('hidden'); }
    }

    async function loadRecentCalls() {
        try {
            const meetings = await apiCall('/meetings/');
            const container = document.getElementById('recentCallsList');
            const calls = meetings.filter(m => m.type === 'instant').slice(0, 5);
            if (calls.length > 0) {
                container.innerHTML = calls.map(c => `
                    <div class="flex items-center justify-between p-4 bg-gray-50/50 dark:bg-gray-800/10 rounded-xl border border-gray-50 dark:border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-[#1a73e8]/10 rounded-full flex items-center justify-center text-[#1a73e8]"><span class="material-symbols-outlined text-sm">videocam</span></div>
                            <div><h4 class="text-xs font-semibold">${c.title}</h4><p class="text-[9px] text-gray-400 uppercase tracking-widest">${new Date(c.created_at).toLocaleDateString()}</p></div>
                        </div>
                        <button onclick="window.location.href='/meet/${c.meeting_id}'" class="text-[#1a73e8] text-[10px] font-bold uppercase tracking-widest hover:underline">Redial</button>
                    </div>
                `).join('');
            } else { container.innerHTML = '<p class="text-gray-400 text-sm italic px-1">No recent calling activity.</p>'; }
        } catch (e) { }
    }

    function joinByCode() {
        const val = codeInput.value.trim();
        let code = val;
        if (code.includes('/meet/')) code = code.split('/meet/')[1].split('?')[0].split('#')[0];
        code = code.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase();
        window.location.href = `/meet/${code}`;
    }

    function copyGeneratedLink() { navigator.clipboard.writeText('https://' + document.getElementById('generatedLink').textContent).then(() => alert('Copied!')); }
    function closeLaterModal() { document.getElementById('laterModal').classList.add('hidden'); }

    // Init
    loadOverviewData();
</script>
{% endblock %}