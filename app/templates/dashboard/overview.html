{% extends "base.html" %}

{% block content %}
<div class="flex h-screen bg-gray-50 dark:bg-gray-900 overflow-hidden">
    <!-- Mobile Header -->
    <div
        class="fixed top-0 left-0 right-0 z-40 md:hidden bg-white dark:bg-[#1a1c1e] border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex items-center justify-between">
        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
            <span class="material-symbols-outlined">menu</span>
        </button>
        <h1 class="text-lg font-bold">Auralis</h1>
        <div class="w-10"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>

    <!-- Sidebar -->
    {% set active_page = 'overview' %}
    {% include 'components/_sidebar.html' %}

    <!-- Main Content -->
    <main class="flex-1 flex flex-col pt-16 md:pt-0 overflow-hidden relative bg-[#f8f9fa] dark:bg-[#1a1c1e]">
        <div class="flex-1 flex flex-col overflow-hidden animate-fade-in p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 md:mb-10">
                <div>
                    <h2 class="text-3xl md:text-4xl font-outfit font-bold">Overview</h2>
                    <p class="text-sm text-gray-500 mt-1">Hello <span id="displayUserNameOverview"
                            class="text-brand-500 font-semibold">User</span>, here's your activity.</p>
                </div>
                <button onclick="document.getElementById('uploadModal').classList.remove('hidden')"
                    class="w-full md:w-auto bg-brand-500 hover:bg-brand-600 text-white px-8 py-3 rounded-xl text-sm font-bold transition-all shadow-lg shadow-brand-500/20 active:scale-95">
                    Upload Meeting
                </button>
            </header>

            <div class="flex-1 overflow-y-auto space-y-10 custom-scrollbar pr-2">
                <!-- Stats Row -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-8">
                    <div
                        class="glass p-8 rounded-3xl border border-white/20 shadow-sm transition-transform hover:scale-[1.02]">
                        <div class="flex items-center gap-4 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-brand-500/10 flex items-center justify-center text-brand-500">
                                <span class="material-symbols-outlined">video_library</span>
                            </div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Total Meetings</h3>
                        </div>
                        <p id="totalMeetingsCount" class="text-5xl font-outfit font-bold">0</p>
                    </div>
                    <div
                        class="glass p-8 rounded-3xl border border-white/20 shadow-sm transition-transform hover:scale-[1.02]">
                        <div class="flex items-center gap-4 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-green-500/10 flex items-center justify-center text-green-500">
                                <span class="material-symbols-outlined">schedule</span>
                            </div>
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Upcoming</h3>
                        </div>
                        <p id="upcomingMeetingsCount" class="text-5xl font-outfit font-bold">0</p>
                    </div>
                </div>

                <!-- History/List Section -->
                <div>
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em] mb-6">Recent Meetings
                    </h3>
                    <div id="meetingsListOverview" class="space-y-4">
                        <!-- Data populated via JS -->
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Upload Modal (same as before) -->
{% include 'dashboard/components/_upload_modal.html' %}

<script>
    checkAuth();

    // Determine meeting status badge
    function getStatusBadge(meeting) {
        const now = new Date();
        const createdAt = new Date(meeting.created_at);
        const endedAt = meeting.ended_at ? new Date(meeting.ended_at) : null;
        
        // If explicitly ended
        if (endedAt && now > endedAt) {
            return { text: 'Ended', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' };
        }
        
        // If status is active or in active_meetings
        if (meeting.status === 'active') {
            return { text: 'Running', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' };
        }
        
        // If scheduled for future
        if (meeting.is_scheduled || meeting.status === 'scheduled') {
            return { text: 'Scheduled', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' };
        }
        
        // Default to ended if meeting is old
        if (now - createdAt > 3600000) { // More than 1 hour old
            return { text: 'Ended', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' };
        }
        
        return { text: 'Running', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' };
    }

    // Load overview data
    async function loadOverviewData() {
        try {
            const meetings = await apiCall('/meetings/');
            document.getElementById('totalMeetingsCount').textContent = meetings.length;

            const upcoming = meetings.filter(m => m.status === 'scheduled');
            document.getElementById('upcomingMeetingsCount').textContent = upcoming.length;

            const container = document.getElementById('meetingsListOverview');
            if (meetings.length > 0) {
                container.innerHTML = meetings.map(m => {
                    const badge = getStatusBadge(m);
                    const dateStr = new Date(m.created_at).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-md transition-all">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <span class="material-symbols-outlined text-gray-400">videocam</span>
                                    <div>
                                        <h4 class="font-semibold text-gray-900 dark:text-white">${m.title || 'Untitled Meeting'}</h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${dateStr}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${badge.color}">
                                    ${badge.text}
                                </span>
                                ${m.meeting_id ? `<a href="/meet/${m.meeting_id}" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-semibold transition-all">Join</a>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No meetings yet</p>';
            }

            // Update user name
            const user = JSON.parse(localStorage.getItem('auralis_user') || '{}');
            if (user.name) {
                document.getElementById('displayUserNameOverview').textContent = user.name;
            }
        } catch (err) {
            console.error('Load overview error:', err);
        }
    }

    loadOverviewData();
    // Refresh every 30 seconds
    setInterval(loadOverviewData, 30000);
</script>
{% endblock %}