{% extends "base.html" %}

{% block content %}
<!-- Google Material Symbols -->
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<div class="h-screen bg-[#202124] text-white flex flex-col overflow-hidden font-sans">

    <!-- MAIN AREA -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- LEFT: VIDEO GRID -->
        <div class="flex-1 flex flex-col relative p-4 transition-all duration-300" id="mainStage">
            <div id="videoGrid" class="h-full w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr">
                <!-- Local Video -->
                <div
                    class="relative bg-[#3c4043] rounded-xl overflow-hidden flex items-center justify-center border border-gray-700 group">
                    <video id="localVideo" autoplay muted playsinline
                        class="w-full h-full object-cover transform scale-x-[-1]"></video>
                    <div
                        class="absolute bottom-4 left-4 bg-black/40 backdrop-blur-md px-3 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2">
                        <span id="localNameDisplay">You</span>
                        <span id="localStatusIcons" class="flex gap-1">
                            <span class="material-symbols-outlined text-red-500 text-sm hidden"
                                id="localMicOff">mic_off</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Floating Captions Area -->
            <div id="captionsArea"
                class="absolute bottom-24 left-1/2 transform -translate-x-1/2 w-full max-w-2xl text-center px-4 pointer-events-none">
                <div id="captionContent"
                    class="bg-black/60 backdrop-blur-md text-white px-4 py-2 rounded-lg text-lg hidden inline-block">
                </div>
            </div>

            <!-- Toast Notifications -->
            <div id="toastContainer" class="absolute top-4 right-4 z-50 flex flex-col gap-2"></div>
        </div>

        <!-- RIGHT SIDEBARS -->
        <aside id="rightSidebar"
            class="hidden w-[360px] bg-white dark:bg-[#202124] border-l border-gray-700 flex flex-col m-4 rounded-xl overflow-hidden shadow-2xl">
            <!-- Sidebar Header -->
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-[#202124]">
                <h3 id="sidebarTitle" class="text-xl font-medium">Messages</h3>
                <button onclick="closeSidebar()" class="p-2 hover:bg-[#3c4043] rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- CHAT CONTENT -->
            <div id="chatView" class="hidden flex-1 flex flex-col overflow-hidden">
                <div id="chatMessages" class="flex-1 overflow-y-auto p-5 space-y-4">
                    <div class="bg-[#f1f3f4] dark:bg-[#3c4043] p-4 rounded-lg text-sm text-center">
                        Messages can only be seen by people in the call and are deleted when the call ends.
                    </div>
                </div>
                <form id="chatForm" class="p-4 bg-[#202124]">
                    <div class="relative flex items-center gap-2 bg-[#3c4043] rounded-full px-4 py-1">
                        <input type="text" id="chatInput" placeholder="Send a message"
                            class="flex-1 bg-transparent text-white py-3 outline-none text-sm">
                        <button type="submit" class="text-blue-400 hover:text-blue-300 disabled:opacity-50">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- PARTICIPANTS CONTENT -->
            <div id="participantsView" class="hidden flex-1 flex flex-col overflow-hidden p-5">
                <div class="flex items-center justify-between mb-6">
                    <span class="text-sm font-medium text-gray-400 uppercase tracking-wider">In call</span>
                    <span id="participantCount" class="bg-blue-600 px-2 py-0.5 rounded text-xs font-bold">1</span>
                </div>
                <div id="participantsList" class="space-y-4 overflow-y-auto pr-2">
                    <!-- Participant Items -->
                </div>
            </div>
        </aside>
    </div>

    <!-- BOTTOM CONTROL BAR -->
    <footer class="h-20 bg-[#202124] flex items-center justify-between px-6 z-30">
        <!-- Left: Meeting Info -->
        <div class="flex items-center gap-4 w-1/4">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="w-8 h-8 object-contain">
            <div class="hidden md:block">
                <p id="footerTime" class="text-sm font-medium">12:00 PM</p>
                <div class="flex items-center gap-2 text-gray-400">
                    <span class="text-sm font-medium tracking-tight">{{ meeting_id }}</span>
                    <button onclick="copyMeetingLink()" class="hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-[18px]">content_copy</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Center: Main Controls -->
        <div class="flex items-center gap-3">
            <button onclick="toggleAudio()" id="btnAudio" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span id="iconAudio" class="material-symbols-outlined">mic</span>
            </button>
            <button onclick="toggleVideo()" id="btnVideo" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span id="iconVideo" class="material-symbols-outlined">videocam</span>
            </button>
            <button onclick="toggleCaptions()" id="btnCaptions" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span class="material-symbols-outlined">closed_caption</span>
            </button>
            <button onclick="sendReaction('ðŸ’–')" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155] hidden sm:flex">
                <span class="material-symbols-outlined">add_reaction</span>
            </button>
            <button onclick="shareScreen()" id="btnShare" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span class="material-symbols-outlined">present_to_all</span>
            </button>
            <button onclick="raiseHand()" id="btnHand" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span class="material-symbols-outlined">front_hand</span>
            </button>
            <button onclick="showMoreMenu()" class="ctrl-btn bg-[#3c4043] hover:bg-[#4d5155]">
                <span class="material-symbols-outlined">more_vert</span>
            </button>
            <button onclick="leaveCall()"
                class="w-16 h-10 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center transition-all ml-4">
                <span class="material-symbols-outlined text-white">call_end</span>
            </button>
        </div>

        <!-- Right: Tool Buttons -->
        <div class="flex items-center justify-end gap-2 w-1/4">
            <button onclick="openTab('info')" id="btnInfo" class="tool-btn">
                <span class="material-symbols-outlined">info</span>
            </button>
            <button onclick="openTab('participants')" id="btnParticipants" class="tool-btn relative">
                <span class="material-symbols-outlined">group</span>
                <div id="participantDot" class="hidden absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full"></div>
            </button>
            <button onclick="openTab('chat')" id="btnChat" class="tool-btn relative">
                <span class="material-symbols-outlined">chat</span>
                <div id="chatBadge"
                    class="hidden absolute top-2 right-2 w-2 h-2 bg-blue-500 rounded-full border-2 border-[#202124]">
                </div>
            </button>
            <button class="tool-btn">
                <span class="material-symbols-outlined">category</span>
            </button>
        </div>
    </footer>
</div>

<style>
    .ctrl-btn {
        @apply w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200;
        background-color: #3c4043;
    }

    .ctrl-btn:hover {
        background-color: #4d5155;
    }

    .tool-btn {
        @apply w-12 h-12 rounded-full flex items-center justify-center hover:bg-[#3c4043] text-gray-300 transition-colors;
    }

    .active-tool {
        @apply text-blue-400 bg-blue-400/10 hover:bg-blue-400/20;
    }

    .btn-red {
        background-color: #ea4335 !important;
        color: white !important;
    }

    .btn-red:hover {
        background-color: #d93025 !important;
    }

    @keyframes float-emoji {
        0% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        100% {
            transform: translateY(-150px) scale(1.5);
            opacity: 0;
        }
    }

    .emoji-float {
        position: absolute;
        bottom: 100px;
        left: 50%;
        font-size: 24px;
        animation: float-emoji 2s ease-out forwards;
        pointer-events: none;
        z-index: 100;
    }

    #videoGrid>div {
        transition: all 0.3s ease-in-out;
    }
</style>

<script>
    const meetingId = "{{ meeting_id }}";
    const socket = io();
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // --- STATE ---
    let localStream;
    let peers = {}; // { sid: { connection, name, stream } }
    let myName = "User";
    let isVideo = true, isAudio = true, isCaptions = false, isHandRaised = false;
    let activeTab = null;

    // --- RECOGNITION (Captions) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');

            showCaptions("You: " + transcript);
            socket.emit('caption_broadcast', { text: transcript });
        };
    }

    // --- INITIALIZATION ---
    async function init() {
        // Clock
        updateTime();
        setInterval(updateTime, 10000);

        // Name from cache or prompt
        const userCache = JSON.parse(localStorage.getItem('auralis_user') || '{}');
        myName = userCache.name || prompt("Enter your name:") || "Guest_" + Math.floor(Math.random() * 999);
        document.getElementById('localNameDisplay').textContent = myName + " (You)";

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;

            socket.emit('join_meeting', { meetingId, name: myName });
            renderParticipants();
        } catch (e) {
            console.error(e);
            showToast("Camera/Mic access denied.");
        }
    }

    function updateTime() {
        const now = new Date();
        document.getElementById('footerTime').textContent = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    // --- SOCKET LOGIC ---

    socket.on('room_info', (data) => {
        data.users.forEach(user => {
            initConnection(user.sid, user.name, true);
        });
        updateParticipantCount(data.users.length + 1);
    });

    socket.on('user_joined', (data) => {
        showToast(`${data.name} joined`);
        initConnection(data.sid, data.name, false);
        updateParticipantCount();
    });

    socket.on('user_left', (data) => {
        const peer = peers[data.sid];
        if (peer) {
            showToast(`${peer.name} left`);
            if (peer.connection) peer.connection.close();
            delete peers[data.sid];
            const el = document.getElementById('video-' + data.sid);
            if (el) el.remove();
            updateParticipantCount();
            renderParticipants();
        }
    });

    socket.on('signal', async (data) => {
        const peer = peers[data.from];
        if (!peer) return;
        const pc = peer.connection;
        try {
            if (data.type === 'offer') {
                await pc.setRemoteDescription(data.data);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                socket.emit('signal', { type: 'answer', data: answer, to: data.from });
            } else if (data.type === 'answer') {
                await pc.setRemoteDescription(data.data);
            } else if (data.type === 'candidate') {
                if (data.data) await pc.addIceCandidate(data.data);
            }
        } catch (e) { console.error(e); }
    });

    socket.on('chat_message', (data) => {
        appendMessage(data);
        if (activeTab !== 'chat') {
            document.getElementById('chatBadge').classList.remove('hidden');
        }
    });

    socket.on('reaction', (data) => floatEmoji(data.emoji));

    socket.on('hand_raised', (data) => {
        showToast(`${data.name} raised their hand`, 'info');
    });

    socket.on('caption_broadcast', (data) => {
        if (isCaptions) showCaptions(`${data.from}: ${data.text}`);
    });

    // --- WebRTC HANDSHAKE ---

    function initConnection(sid, name, isInitiator) {
        const pc = new RTCPeerConnection(rtcConfig);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (event) => {
            if (peers[sid] && peers[sid].stream) return;
            peers[sid].stream = event.streams[0];
            createRemoteVideoElement(sid, name, event.streams[0]);
            renderParticipants();
        };

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('signal', { type: 'candidate', data: event.candidate, to: sid });
            }
        };

        peers[sid] = { connection: pc, name: name, stream: null };

        if (isInitiator) {
            pc.onnegotiationneeded = async () => {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('signal', { type: 'offer', data: offer, to: sid });
            };
        }
    }

    // --- UI HELPERS ---

    function createRemoteVideoElement(sid, name, stream) {
        let el = document.getElementById('video-' + sid);
        if (el) return;

        el = document.createElement('div');
        el.id = 'video-' + sid;
        el.className = "relative bg-[#3c4043] rounded-xl overflow-hidden flex items-center justify-center border border-gray-700 group";
        el.innerHTML = `
            <video autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute bottom-4 left-4 bg-black/40 backdrop-blur-md px-3 py-1.5 rounded-lg text-sm font-medium">
                ${name}
            </div>
        `;
        el.querySelector('video').srcObject = stream;
        document.getElementById('videoGrid').appendChild(el);
    }

    function openTab(tab) {
        const sidebar = document.getElementById('rightSidebar');

        if (activeTab === tab) {
            closeSidebar();
            return;
        }

        activeTab = tab;
        sidebar.classList.remove('hidden');
        document.getElementById('chatView').classList.add('hidden');
        document.getElementById('participantsView').classList.add('hidden');

        // Reset tool buttons
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active-tool'));

        if (tab === 'chat') {
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "In-call messages";
            document.getElementById('btnChat').classList.add('active-tool');
            document.getElementById('chatBadge').classList.add('hidden');
        } else if (tab === 'participants') {
            document.getElementById('participantsView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "People";
            document.getElementById('btnParticipants').classList.add('active-tool');
            renderParticipants();
        } else if (tab === 'info') {
            const url = `${window.location.origin}/meet/${meetingId}`;
            navigator.clipboard.writeText(url);
            showToast("Meeting link copied to clipboard");
            activeTab = null;
            sidebar.classList.add('hidden');
        }
    }

    function closeSidebar() {
        document.getElementById('rightSidebar').classList.add('hidden');
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active-tool'));
        activeTab = null;
    }

    function renderParticipants() {
        const list = document.getElementById('participantsList');
        list.innerHTML = "";

        // Me
        list.appendChild(createParticipantItem(myName, "You", true));

        // Others
        Object.keys(peers).forEach(sid => {
            list.appendChild(createParticipantItem(peers[sid].name, "Participant", false));
        });

        updateParticipantCount();
    }

    function createParticipantItem(name, role, isMe) {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between";
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold font-sans">
                    ${name.charAt(0).toUpperCase()}
                </div>
                <div>
                    <p class="text-sm font-medium">${name}</p>
                    <p class="text-[10px] text-gray-500 uppercase">${role}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px] text-gray-400">mic</span>
                <span class="material-symbols-outlined text-[20px] text-gray-400">more_vert</span>
            </div>
        `;
        return div;
    }

    function updateParticipantCount(count) {
        const c = count || (Object.keys(peers).length + 1);
        document.getElementById('participantCount').textContent = c;
    }

    // --- ACTIONS ---

    function toggleAudio() {
        isAudio = !isAudio;
        localStream.getAudioTracks().forEach(t => t.enabled = isAudio);
        const btn = document.getElementById('btnAudio');
        const icon = document.getElementById('iconAudio');

        if (isAudio) {
            btn.classList.remove('btn-red');
            icon.textContent = "mic";
            document.getElementById('localMicOff').classList.add('hidden');
        } else {
            btn.classList.add('btn-red');
            icon.textContent = "mic_off";
            document.getElementById('localMicOff').classList.remove('hidden');
        }
    }

    function toggleVideo() {
        isVideo = !isVideo;
        localStream.getVideoTracks().forEach(t => t.enabled = isVideo);
        const btn = document.getElementById('btnVideo');
        const icon = document.getElementById('iconVideo');

        if (isVideo) {
            btn.classList.remove('btn-red');
            icon.textContent = "videocam";
        } else {
            btn.classList.add('btn-red');
            icon.textContent = "videocam_off";
        }
    }

    function toggleCaptions() {
        isCaptions = !isCaptions;
        const btn = document.getElementById('btnCaptions');
        if (isCaptions) {
            btn.classList.add('text-blue-400', 'bg-blue-400/10');
            if (recognition) recognition.start();
        } else {
            btn.classList.remove('text-blue-400', 'bg-blue-400/10');
            if (recognition) recognition.stop();
            document.getElementById('captionContent').classList.add('hidden');
        }
    }

    function showCaptions(text) {
        const el = document.getElementById('captionContent');
        el.textContent = text;
        el.classList.remove('hidden');
        clearTimeout(el.timeout);
        el.timeout = setTimeout(() => el.classList.add('hidden'), 3000);
    }

    function raiseHand() {
        isHandRaised = !isHandRaised;
        const btn = document.getElementById('btnHand');
        if (isHandRaised) {
            btn.classList.add('text-yellow-400', 'bg-yellow-400/10');
            socket.emit('raise_hand');
        } else {
            btn.classList.remove('text-yellow-400', 'bg-yellow-400/10');
        }
    }

    function sendReaction(emoji) {
        socket.emit('reaction', { emoji });
        floatEmoji(emoji);
    }

    function floatEmoji(emoji) {
        const div = document.createElement('div');
        div.className = "emoji-float";
        div.textContent = emoji || "ðŸ’–";
        document.getElementById('mainStage').appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    function shareScreen() {
        navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
            const track = stream.getVideoTracks()[0];
            Object.values(peers).forEach(p => {
                const sender = p.connection.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(track);
            });
            document.getElementById('localVideo').srcObject = stream;
            track.onended = () => {
                const camTrack = localStream.getVideoTracks()[0];
                Object.values(peers).forEach(p => {
                    const sender = p.connection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(camTrack);
                });
                document.getElementById('localVideo').srcObject = localStream;
            };
        });
    }

    function copyMeetingLink() {
        const url = `${window.location.origin}/meet/${meetingId}`;
        navigator.clipboard.writeText(url);
        showToast("Copied meeting link");
    }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `p-4 rounded-lg shadow-lg text-sm font-medium animate-fade-in ${type === 'success' ? 'bg-blue-600' : 'bg-[#3c4043]'} text-white border border-gray-600`;
        toast.textContent = msg;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function appendMessage(data) {
        const isMe = data.sid === socket.id;
        const div = document.createElement('div');
        div.className = "flex flex-col";
        div.innerHTML = `
            <div class="flex items-baseline gap-2 mb-1">
                <span class="text-sm font-medium ${isMe ? 'text-blue-400' : 'text-gray-300'}">${data.from}</span>
                <span class="text-[10px] text-gray-500">${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</span>
            </div>
            <p class="text-sm text-gray-200 leading-relaxed">${data.message}</p>
        `;
        const container = document.getElementById('chatMessages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function leaveCall() {
        if (confirm("Leave this call?")) {
            window.location.href = '/dashboard/';
        }
    }

    document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const inp = document.getElementById('chatInput');
        if (inp.value.trim()) {
            socket.emit('send_chat', { meetingId, message: inp.value.trim() });
            inp.value = '';
        }
    });

    init();
</script>
{% endblock %}