{% extends "base.html" %}

{% block content %}
<!-- Google Material Symbols -->
<link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<div class="h-screen bg-[#1a1c1e] text-[#e8eaed] flex flex-col overflow-hidden font-sans">

    <!-- MEETING INFO BAR -->
    <div class="bg-[#202124] border-b border-gray-700 px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div>
                <p class="text-xs text-gray-500 uppercase tracking-wider">Meeting code</p>
                <p id="meetingCode" class="text-lg font-bold text-white font-mono">{{ meeting_id }}</p>
            </div>
            <button onclick="copyMeetingCode()"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium text-white transition-colors">
                <span class="material-symbols-outlined"
                    style="font-size: 18px; vertical-align: middle; margin-right: 4px;">content_copy</span>Copy Link
            </button>
        </div>
        <div class="flex items-center gap-8">
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wider">Duration</p>
                <p id="meetingDuration" class="text-lg font-bold text-white">00:00</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wider">Participants</p>
                <p id="totalParticipants" class="text-lg font-bold text-blue-400">1</p>
            </div>
        </div>
    </div>

    <!-- MAIN AREA -->
    <div class="flex-1 flex overflow-hidden relative">

        <!-- LEFT: VIDEO GRID -->
        <div class="flex-1 flex flex-col relative p-4 transition-all duration-300" id="mainStage">
            <div id="videoGrid" class="h-full w-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr">
                <!-- Local Video -->
                <div
                    class="relative bg-gradient-to-br from-[#3c4043] to-[#2d2f32] rounded-3xl overflow-hidden flex flex-col items-center justify-center border-2 border-white/5 shadow-2xl group transition-all duration-500 hover:border-brand-500/50">
                    <video id="localVideo" autoplay muted playsinline
                        class="w-full h-full object-cover transform scale-x-[-1]"></video>
                    <div id="videoPlaceholder"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-[#3c4043] to-[#2d2f32] hidden">
                        <span class="material-symbols-outlined text-5xl text-gray-500 mb-4">videocam_off</span>
                        <p class="text-gray-400 text-sm">Camera is off</p>
                    </div>
                    <div
                        class="absolute bottom-6 left-6 glass px-4 py-2 rounded-2xl text-sm font-bold flex items-center gap-2 shadow-lg">
                        <span id="localNameDisplay" class="font-outfit">You</span>
                        <div id="localStatusIcons" class="flex gap-1">
                            <span class="material-symbols-outlined text-red-500 text-sm hidden"
                                id="localMicOff">mic_off</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Captions Area -->
            <div id="captionsArea"
                class="absolute bottom-24 left-1/2 transform -translate-x-1/2 w-full max-w-2xl text-center px-4 pointer-events-none">
                <div id="captionContent"
                    class="bg-black/60 backdrop-blur-md text-white px-4 py-2 rounded-lg text-lg hidden inline-block">
                </div>
            </div>

            <!-- Toast Notifications -->
            <div id="toastContainer" class="absolute top-4 right-4 z-50 flex flex-col gap-2"></div>
        </div>

        <!-- RIGHT SIDEBARS -->
        <aside id="rightSidebar"
            class="fixed md:relative top-4 right-4 bottom-4 md:top-0 md:right-0 md:bottom-0 z-50 w-[380px] hidden glass border-white/10 flex flex-col rounded-3xl overflow-hidden shadow-2xl transition-all duration-300">
            <!-- Sidebar Header -->
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-[#202124]">
                <h3 id="sidebarTitle" class="text-xl font-medium">Messages</h3>
                <button onclick="closeSidebar()" class="p-2 hover:bg-[#3c4043] rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <!-- CHAT CONTENT -->
            <div id="chatView" class="hidden flex-1 flex flex-col overflow-hidden bg-[#1a1c1e]">
                <div id="chatMessages" class="flex-1 overflow-y-auto p-5 space-y-4 bg-[#262829]">
                    <div class="bg-[#3c4043] p-4 rounded-lg text-sm text-center text-gray-300">
                        Messages can only be seen by people in the call and are deleted when the call ends.
                    </div>
                </div>
                <form id="chatForm" class="p-4 bg-[#202124] border-t border-gray-700">
                    <div class="relative flex items-center gap-2 bg-[#3c4043] rounded-full px-4 py-1">
                        <input type="text" id="chatInput" placeholder="Send a message"
                            class="flex-1 bg-transparent text-white placeholder-gray-400 py-3 outline-none text-sm">
                        <button type="submit"
                            class="text-blue-400 hover:text-blue-300 disabled:opacity-50 transition-colors">
                            <span class="material-symbols-outlined">send</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- PARTICIPANTS CONTENT -->
            <div id="participantsView" class="hidden flex-1 flex flex-col overflow-hidden p-5">
                <div class="flex items-center justify-between mb-6">
                    <span class="text-sm font-medium text-gray-400 uppercase tracking-wider">In call</span>
                    <span id="participantCount" class="bg-blue-600 px-2 py-0.5 rounded text-xs font-bold">1</span>
                </div>
                <div id="participantsList" class="space-y-4 overflow-y-auto pr-2">
                    <!-- Participant Items -->
                </div>
            </div>

            <!-- AGENDA CONTENT (Host Only) -->
            <div id="agendaView" class="hidden flex-1 flex flex-col overflow-hidden p-5">
                <div class="mb-4 flex justify-between items-center">
                    <div>
                        <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-2">Private Agenda</h4>
                        <p class="text-xs text-gray-500">Only you can see this.</p>
                    </div>
                </div>
                <textarea id="agendaInput"
                    class="w-full flex-1 bg-[#3c4043] rounded-lg p-4 text-sm text-gray-200 resize-none outline-none focus:ring-1 focus:ring-blue-500 font-mono leading-relaxed"
                    placeholder="Type your meeting agenda notes here..."
                    onblur="saveAgenda()">{{ meeting.agenda }}</textarea>
                <div class="mt-2 text-xs text-gray-500 text-right" id="agendaStatus">Changes saved</div>
            </div>

            <!-- TRANSCRIPT CONTENT -->
            <div id="transcriptView" class="hidden flex-1 flex flex-col overflow-hidden p-5">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-2">Live Transcript</h4>
                    <p class="text-xs text-gray-500">Real-time speech to text.</p>
                </div>
                <div id="transcriptList" class="flex-1 overflow-y-auto space-y-4 pr-2 font-mono text-sm">
                    <!-- Transcripts go here -->
                </div>
            </div>

            <!-- DELEGATE CONTENT -->
            <div id="delegateView" class="hidden flex-1 flex flex-col overflow-hidden p-5">
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-2">AI Delegate</h4>
                    <p class="text-xs text-gray-500">Your digital twin can attend this meeting for you.</p>
                </div>

                <div class="space-y-6">
                    <div class="bg-[#3c4043] p-4 rounded-xl">
                        <label class="block text-xs font-medium text-gray-400 uppercase mb-2">Speaking Style</label>
                        <select id="delegateStyle"
                            class="w-full bg-[#202124] text-white rounded-lg px-3 py-2 text-sm outline-none border border-gray-600 focus:border-blue-500">
                            <option value="professional">Professional & Concise</option>
                            <option value="friendly">Friendly & Casual</option>
                            <option value="detailed">Detailed & Analytical</option>
                            <option value="enthusiastic">Enthusiastic & High Energy</option>
                        </select>
                    </div>

                    <div class="bg-[#3c4043] p-4 rounded-xl">
                        <label class="block text-xs font-medium text-gray-400 uppercase mb-2">Status</label>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">Enable Digital Twin</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="delegateToggle" class="sr-only peer"
                                    onchange="toggleDelegate(this.checked)">
                                <div
                                    class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                </div>
                            </label>
                        </div>
                        <p class="mt-2 text-xs text-gray-400">
                            When enabled, your AI will listen to the meeting and respond when you are mentioned or asked
                            a question.
                        </p>
                    </div>

                    <div id="delegateActiveBg"
                        class="hidden p-4 rounded-xl bg-gradient-to-br from-blue-900/50 to-purple-900/50 border border-blue-500/30">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="material-symbols-outlined text-blue-400 animate-pulse">smart_toy</span>
                            <span class="text-sm font-bold text-blue-100">AI Active</span>
                        </div>
                        <p class="text-xs text-blue-200">Processing meeting context...</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- BOTTOM CONTROL BAR -->
    <footer
        class="fixed bottom-8 left-1/2 -translate-x-1/2 glass px-8 h-20 rounded-[2.5rem] flex items-center gap-12 shadow-2xl z-50 border-white/20">
        <!-- Center: Main Controls -->
        <div class="flex items-center gap-4">
            <button onclick="toggleAudio()" id="btnAudio"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span id="iconAudio" class="material-symbols-outlined">mic</span>
            </button>
            <button onclick="toggleVideo()" id="btnVideo"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span id="iconVideo" class="material-symbols-outlined">videocam</span>
            </button>
            <button onclick="toggleCaptions()" id="btnCaptions"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span class="material-symbols-outlined">closed_caption</span>
            </button>
            <button onclick="openTab('transcripts')" id="btnTranscripts"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10" title="View Transcripts">
                <span class="material-symbols-outlined">description</span>
            </button>

            <button onclick="leaveCall()"
                class="w-20 h-10 rounded-3xl bg-red-500 hover:bg-red-600 flex items-center justify-center transition-all shadow-lg shadow-red-500/30">
                <span class="material-symbols-outlined text-white">call_end</span>
            </button>

            <div class="h-8 w-px bg-white/10 mx-2"></div>

            <button onclick="shareScreen()" id="btnShare"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span class="material-symbols-outlined">present_to_all</span>
            </button>
            <button onclick="raiseHand()" id="btnHand"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span class="material-symbols-outlined">front_hand</span>
            </button>
            <button onclick="openTab('chat')" id="btnChat"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10 relative">
                <span class="material-symbols-outlined">chat</span>
                <div id="chatBadge"
                    class="hidden absolute top-0 right-0 w-3 h-3 bg-brand-500 rounded-full border-2 border-white/20">
                </div>
            </button>
            <button onclick="openTab('participants')" id="btnParticipants"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span class="material-symbols-outlined">group</span>
            </button>
            <button onclick="toggleAIDelegate()" id="btnAI"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10" title="Delegate to AI">
                <span class="material-symbols-outlined">smart_toy</span>
            </button>

            {% if current_user_id == meeting.host_id %}
            <button onclick="openTab('agenda')" id="btnAgenda"
                class="ctrl-btn bg-white/10 hover:bg-white/20 border border-white/10">
                <span class="material-symbols-outlined">view_agenda</span>
            </button>
            {% endif %}
        </div>
    </footer>
</div>

<style>
    .ctrl-btn {
        @apply w-12 h-12 rounded-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-90 text-white shadow-lg;
    }

    .tool-btn {
        @apply w-12 h-12 rounded-2xl flex items-center justify-center hover:bg-white/10 text-gray-300 transition-colors;
    }

    .active-tool {
        @apply text-blue-400 bg-blue-400/10 hover:bg-blue-400/20;
    }

    .btn-red {
        background-color: #ea4335 !important;
        color: white !important;
    }

    .btn-red:hover {
        background-color: #d93025 !important;
    }

    @keyframes float-emoji {
        0% {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        100% {
            transform: translateY(-150px) scale(1.5);
            opacity: 0;
        }
    }

    .emoji-float {
        position: absolute;
        bottom: 100px;
        left: 50%;
        font-size: 24px;
        animation: float-emoji 2s ease-out forwards;
        pointer-events: none;
        z-index: 100;
    }

    #videoGrid>div {
        transition: all 0.3s ease-in-out;
        border: 2px solid #404043;
    }

    #videoGrid>div:hover {
        border-color: #4a7fd7;
        box-shadow: 0 0 20px rgba(74, 127, 215, 0.3);
    }

    /* Video name badge improvement */
    #videoGrid .glass {
        background: rgba(20, 20, 22, 0.85);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Chat improvements */
    #chatMessages {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    #chatMessages::-webkit-scrollbar {
        width: 6px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: transparent;
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Participants list improvements */
    #participantsList {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    #participantsList::-webkit-scrollbar {
        width: 6px;
    }

    #participantsList::-webkit-scrollbar-track {
        background: transparent;
    }

    #participantsList::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
    }

    #participantsList::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Info bar improvements */
    #meetingCode {
        font-family: 'Courier New', monospace;
        letter-spacing: 0.1em;
        color: #e8eaed;
    }

    /* Toast notification animations */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: slideIn 0.3s ease-out;
    }

    /* Video grid responsive improvements */
    @media (max-width: 1024px) {
        #videoGrid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    }

    @media (max-width: 640px) {
        #videoGrid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    const meetingId = "{{ meeting_id }}";
    const socket = io();
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    // --- STATE ---
    let localStream;
    let peers = {}; // { sid: { connection, name, stream } }
    let myName = "User";
    let isVideo = true, isAudio = true, isCaptions = false, isHandRaised = false;
    let activeTab = null;
    let meetingStartTime = null;

    // --- RECOGNITION (Captions) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');

            showCaptions("You: " + transcript);
            socket.emit('caption_broadcast', { text: transcript });
        };
    }

    // --- INITIALIZATION ---
    async function init() {
        // Set meeting start time
        meetingStartTime = new Date();
        updateMeetingDuration();
        setInterval(updateMeetingDuration, 1000);

        // Display meeting code
        document.getElementById('meetingCode').textContent = meetingId;

        // Name from cache or prompt
        const userCache = JSON.parse(localStorage.getItem('auralis_user') || '{}');
        myName = userCache.name || prompt("Enter your name:") || "Guest_" + Math.floor(Math.random() * 999);
        document.getElementById('localNameDisplay').textContent = myName + " (You)";

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;

            socket.emit('join_meeting', { meetingId, name: myName });
            renderParticipants();
        } catch (e) {
            console.error('Media access error:', e.name, e.message);
            let errorMsg = "Camera/Mic access denied.";

            if (e.name === 'NotReadableError' || e.message.includes('Device in use')) {
                errorMsg = "Camera is already in use by another application. Please close other apps using your camera and try again.";
            } else if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                errorMsg = "Please allow camera and microphone access.";
            } else if (e.name === 'NotFoundError') {
                errorMsg = "Camera or microphone not found on this device.";
            }

            showToast(errorMsg, 'error');
            console.error('Camera error:', errorMsg, e);
        }
    }

    function updateMeetingDuration() {
        if (!meetingStartTime) return;
        const elapsed = Math.floor((new Date() - meetingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('meetingDuration').textContent =
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    // --- SOCKET LOGIC ---

    socket.on('room_info', (data) => {
        console.log('Room info received:', data);
        data.users.forEach(user => {
            initConnection(user.sid, user.name, true);
        });
        updateParticipantCount(data.users.length + 1);
    });

    socket.on('user_joined', (data) => {
        console.log('User joined:', data);
        showToast(`${data.name} joined`);
        initConnection(data.sid, data.name, false);
        updateParticipantCount();
    });

    socket.on('user_left', (data) => {
        const peer = peers[data.sid];
        if (peer) {
            showToast(`${peer.name} left`);
            if (peer.connection) peer.connection.close();
            delete peers[data.sid];
            const el = document.getElementById('video-' + data.sid);
            if (el) el.remove();
            updateParticipantCount();
            renderParticipants();
        }
    });

    socket.on('chat_message', (data) => {
        console.log('Message received:', data);
        appendMessage(data);
        if (activeTab !== 'chat') {
            document.getElementById('chatBadge').classList.remove('hidden');
        }
    });

    socket.on('reaction', (data) => floatEmoji(data.emoji));

    socket.on('hand_raised', (data) => {
        showToast(`${data.name} raised their hand`, 'info');
    });

    socket.on('caption_broadcast', (data) => {
        if (isCaptions) showCaptions(`${data.from}: ${data.text}`);

        // Also append to transcript panel if it exists
        if (document.getElementById('transcriptView')) {
            renderTranscriptItem(data.from, data.text, new Date());
        }
    });

    socket.on('transcript_history', (data) => {
        const container = document.getElementById('transcriptList');
        if (container) {
            container.innerHTML = '';
            data.history.forEach(item => {
                renderTranscriptItem(item.from, item.text, item.timestamp);
            });
            container.scrollTop = container.scrollHeight;
        }
    });

    function renderTranscriptItem(speaker, text, time) {
        const container = document.getElementById('transcriptList');
        if (!container) return;

        const div = document.createElement('div');
        div.className = "flex flex-col mb-3 pb-2 border-b border-gray-700/50";
        const timeStr = typeof time === 'string' ? new Date(time).toLocaleTimeString() : time.toLocaleTimeString();

        div.innerHTML = `
            <div class="flex items-center gap-2 mb-1">
                <span class="font-bold text-blue-400 text-xs">${speaker}</span>
                <span class="text-[10px] text-gray-500">${timeStr}</span>
            </div>
            <p class="text-gray-300 leading-snug">${text}</p>
        `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    // --- SIGNALING HANDLER ---
    socket.on('signal', async (data) => {
        const from = data.from;
        const type = data.type;
        const signalData = data.data;

        console.log(`Signal received from ${from}:`, type, signalData);

        if (!peers[from]) {
            console.log(`Creating peer connection for ${from} (answerer)`);
            // If we don't have this peer yet, they must be the initiator
            // We'll create a connection without onnegotiationneeded
            const pc = new RTCPeerConnection(rtcConfig);
            if (localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }
            peers[from] = { connection: pc, name: from, stream: null };

            pc.ontrack = (event) => {
                console.log(`Track received from ${from}:`, event.track.kind);
                if (!peers[from]) peers[from] = { connection: pc, name: from, stream: null };
                peers[from].stream = event.streams[0];
                createRemoteVideoElement(from, peers[from].name || from, event.streams[0]);
                renderParticipants();
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log(`Sending ICE candidate to ${from}`);
                    socket.emit('signal', { type: 'candidate', data: event.candidate, to: from });
                }
            };
        }

        try {
            const pc = peers[from].connection;

            if (type === 'offer') {
                console.log(`Processing offer from ${from}`, signalData);
                await pc.setRemoteDescription(signalData);
                const answer = await pc.createAnswer();
                console.log(`Sending answer to ${from}`, answer);
                await pc.setLocalDescription(answer);
                socket.emit('signal', { type: 'answer', data: answer, to: from });
            } else if (type === 'answer') {
                console.log(`Processing answer from ${from}`, signalData);
                await pc.setRemoteDescription(signalData);
            } else if (type === 'candidate') {
                console.log(`Processing ICE candidate from ${from}`, signalData);
                try {
                    if (signalData) {
                        await pc.addIceCandidate(signalData);
                    }
                } catch (e) {
                    console.warn(`Error adding ICE candidate from ${from}:`, e);
                }
            }
        } catch (e) {
            console.error(`Error processing signal from ${from}:`, e);
        }
    });

    // --- WebRTC HANDSHAKE ---

    function initConnection(sid, name, isInitiator) {
        console.log(`initConnection called for ${sid} (${name}), isInitiator=${isInitiator}`);

        if (peers[sid]) {
            console.log(`Connection for ${sid} already exists`);
            return;
        }

        const pc = new RTCPeerConnection(rtcConfig);
        console.log(`RTCPeerConnection created for ${sid}`);

        // Initialize peer object FIRST
        peers[sid] = { connection: pc, name: name, stream: null };

        // Add local tracks
        if (localStream) {
            const tracks = localStream.getTracks();
            console.log(`Adding ${tracks.length} local tracks to ${sid}`);
            tracks.forEach(track => {
                console.log(`Adding track: ${track.kind}`);
                pc.addTrack(track, localStream);
            });
        } else {
            console.warn(`No localStream available for ${sid}`);
        }

        // Handle remote tracks
        pc.ontrack = (event) => {
            console.log(`ontrack event for ${sid}:`, event.track.kind, event.streams.length);
            if (!peers[sid]) peers[sid] = { connection: pc, name: name, stream: null };
            peers[sid].stream = event.streams[0];
            console.log(`Stream assigned for ${sid}, creating video element`);
            createRemoteVideoElement(sid, name, event.streams[0]);
            renderParticipants();
        };

        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                console.log(`ICE candidate from ${sid}:`, event.candidate.candidate);
                socket.emit('signal', { type: 'candidate', data: event.candidate, to: sid });
            } else {
                console.log(`ICE gathering complete for ${sid}`);
            }
        };

        // Handle connection state changes
        pc.onconnectionstatechange = () => {
            console.log(`Connection state with ${sid}: ${pc.connectionState}`);
            if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                console.warn(`Connection lost with ${sid}, removing peer`);
                if (peers[sid]) {
                    peers[sid].connection.close();
                    delete peers[sid];
                    const el = document.getElementById('video-' + sid);
                    if (el) el.remove();
                    renderParticipants();
                }
            }
        };

        pc.oniceconnectionstatechange = () => {
            console.log(`ICE connection state with ${sid}: ${pc.iceConnectionState}`);
        };

        // Initiator creates offer
        if (isInitiator) {
            console.log(`Setting up as initiator for ${sid}`);
            pc.onnegotiationneeded = async () => {
                try {
                    console.log(`onnegotiationneeded fired for ${sid}`);
                    const offer = await pc.createOffer();
                    console.log(`Setting local description (offer) for ${sid}`);
                    await pc.setLocalDescription(offer);
                    console.log(`Sending offer to ${sid}`, offer);
                    socket.emit('signal', { type: 'offer', data: offer, to: sid });
                } catch (e) {
                    console.error(`Error in onnegotiationneeded for ${sid}:`, e);
                }
            };

            // For some browsers, onnegotiationneeded may not fire automatically
            // So we manually create an offer after a short delay
            setTimeout(async () => {
                if (peers[sid] && pc.signalingState === 'stable' && !peers[sid].offerSent) {
                    try {
                        console.log(`Manually creating offer for ${sid}`);
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        peers[sid].offerSent = true;
                        socket.emit('signal', { type: 'offer', data: offer, to: sid });
                    } catch (e) {
                        console.error(`Error manually creating offer for ${sid}:`, e);
                    }
                }
            }, 500);
        }
    }

    // --- UI HELPERS ---

    function createRemoteVideoElement(sid, name, stream) {
        let el = document.getElementById('video-' + sid);
        if (el) return;

        el = document.createElement('div');
        el.id = 'video-' + sid;
        el.className = "relative bg-[#3c4043] rounded-3xl overflow-hidden flex items-center justify-center border-2 border-white/5 shadow-2xl group transition-all duration-500 hover:border-brand-500/50";
        el.innerHTML = `
            <video autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute bottom-6 left-6 glass px-4 py-2 rounded-2xl text-sm font-bold shadow-lg font-outfit">
                ${name}
            </div>
        `;
        el.querySelector('video').srcObject = stream;
        document.getElementById('videoGrid').appendChild(el);
    }

    function openTab(tab) {
        const sidebar = document.getElementById('rightSidebar');

        if (activeTab === tab) {
            closeSidebar();
            return;
        }

        activeTab = tab;
        sidebar.classList.remove('hidden');

        // Hide all views
        ['chatView', 'participantsView', 'agendaView', 'transcriptView', 'delegateView'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.classList.add('hidden');
        });

        // Reset tool buttons
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active-tool'));

        if (tab === 'chat') {
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "In-call messages";
            document.getElementById('btnChat').classList.add('active-tool');
            document.getElementById('chatBadge').classList.add('hidden');
        } else if (tab === 'participants') {
            document.getElementById('participantsView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "People";
            document.getElementById('btnParticipants').classList.add('active-tool');
            renderParticipants();
        } else if (tab === 'agenda') {
            document.getElementById('agendaView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "Private Agenda";
            document.getElementById('btnAgenda').classList.add('active-tool');
        } else if (tab === 'transcripts') {
            document.getElementById('transcriptView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "Transcripts";
            document.getElementById('btnCaptions').classList.add('active-tool'); // Reuse captions button or new one
            socket.emit('request_transcripts', { meetingId });
        } else if (tab === 'delegate') {
            document.getElementById('delegateView').classList.remove('hidden');
            document.getElementById('sidebarTitle').textContent = "AI Delegate";
            document.getElementById('btnAI').classList.add('active-tool');
        }
    }

    function saveAgenda() {
        const text = document.getElementById('agendaInput').value;
        fetch(`/meet/${meetingId}/agenda`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ agenda: text })
        }).then(res => res.json())
            .then(data => {
                if (data.success) {
                    const status = document.getElementById('agendaStatus');
                    status.textContent = "Saved at " + new Date().toLocaleTimeString();
                    status.classList.add('text-green-500');
                    setTimeout(() => status.classList.remove('text-green-500'), 2000);
                }
            });
    }

    function toggleDelegate(enabled) {
        const style = document.getElementById('delegateStyle').value;
        if (enabled) {
            document.getElementById('delegateActiveBg').classList.remove('hidden');
            socket.emit('enable_ai_delegate', { meetingId, name: myName, style, userId: "{{ current_user_id }}" });
        } else {
            // Logic to disable if we want to implement it, currently enabling is one-way in socket.py
            document.getElementById('delegateActiveBg').classList.add('hidden');
        }
    }

    function renderParticipants() {
        const list = document.getElementById('participantsList');
        list.innerHTML = "";

        // Me
        list.appendChild(createParticipantItem(myName, "You", true));

        // Others
        Object.keys(peers).forEach(sid => {
            list.appendChild(createParticipantItem(peers[sid].name, "Participant", false));
        });

        updateParticipantCount();
    }

    function createParticipantItem(name, role, isMe) {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between";
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-xs font-bold font-sans">
                    ${name.charAt(0).toUpperCase()}
                </div>
                <div>
                    <p class="text-sm font-medium">${name}</p>
                    <p class="text-[10px] text-gray-500 uppercase">${role}</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px] text-gray-400">mic</span>
                <span class="material-symbols-outlined text-[20px] text-gray-400">more_vert</span>
            </div>
        `;
        return div;
    }

    function updateParticipantCount(count) {
        const c = count || (Object.keys(peers).length + 1);
        document.getElementById('participantCount').textContent = c;
        document.getElementById('totalParticipants').textContent = c;
    }

    // --- ACTIONS ---

    function copyMeetingCode() {
        const url = `${window.location.origin}/meet/${meetingId}`;
        navigator.clipboard.writeText(url);
        showToast("Meeting link copied! Share it with others.");
    }

    function toggleAudio() {
        isAudio = !isAudio;
        localStream.getAudioTracks().forEach(t => t.enabled = isAudio);
        const btn = document.getElementById('btnAudio');
        const icon = document.getElementById('iconAudio');

        if (isAudio) {
            btn.classList.remove('btn-red');
            icon.textContent = "mic";
            document.getElementById('localMicOff').classList.add('hidden');
        } else {
            btn.classList.add('btn-red');
            icon.textContent = "mic_off";
            document.getElementById('localMicOff').classList.remove('hidden');
        }
    }

    function toggleVideo() {
        isVideo = !isVideo;
        localStream.getVideoTracks().forEach(t => t.enabled = isVideo);
        const btn = document.getElementById('btnVideo');
        const icon = document.getElementById('iconVideo');
        const placeholder = document.getElementById('videoPlaceholder');

        if (isVideo) {
            btn.classList.remove('btn-red');
            icon.textContent = "videocam";
            placeholder.classList.add('hidden');
        } else {
            btn.classList.add('btn-red');
            icon.textContent = "videocam_off";
            placeholder.classList.remove('hidden');
        }
    }

    function toggleCaptions() {
        isCaptions = !isCaptions;
        const btn = document.getElementById('btnCaptions');
        if (isCaptions) {
            btn.classList.add('text-blue-400', 'bg-blue-400/10');
            if (recognition) recognition.start();
        } else {
            btn.classList.remove('text-blue-400', 'bg-blue-400/10');
            if (recognition) recognition.stop();
            document.getElementById('captionContent').classList.add('hidden');
        }
    }

    function showCaptions(text) {
        const el = document.getElementById('captionContent');
        el.textContent = text;
        el.classList.remove('hidden');
        clearTimeout(el.timeout);
        el.timeout = setTimeout(() => el.classList.add('hidden'), 3000);
    }

    function raiseHand() {
        isHandRaised = !isHandRaised;
        const btn = document.getElementById('btnHand');
        if (isHandRaised) {
            btn.classList.add('text-yellow-400', 'bg-yellow-400/10');
            socket.emit('raise_hand');
        } else {
            btn.classList.remove('text-yellow-400', 'bg-yellow-400/10');
        }
    }

    function sendReaction(emoji) {
        socket.emit('reaction', { emoji });
        floatEmoji(emoji);
    }

    function floatEmoji(emoji) {
        const div = document.createElement('div');
        div.className = "emoji-float";
        div.textContent = emoji || "ðŸ’–";
        document.getElementById('mainStage').appendChild(div);
        setTimeout(() => div.remove(), 2000);
    }

    function toggleAIDelegate() {
        const style = prompt("Enable AI Delegate? Enter speaking style (e.g. 'friendly', 'professional', 'sarcastic'):", "professional");
        if (style) {
            socket.emit('enable_ai_delegate', { meetingId, name: myName, style });
            document.getElementById('btnAI').classList.add('text-brand-500', 'bg-brand-500/10');
            showToast("AI Delegate Enabled. It will respond when you are mentioned.");
        }
    }

    function shareScreen() {
        navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
            const track = stream.getVideoTracks()[0];
            Object.values(peers).forEach(p => {
                const sender = p.connection.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.replaceTrack(track);
            });
            document.getElementById('localVideo').srcObject = stream;
            track.onended = () => {
                const camTrack = localStream.getVideoTracks()[0];
                Object.values(peers).forEach(p => {
                    const sender = p.connection.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(camTrack);
                });
                document.getElementById('localVideo').srcObject = localStream;
            };
        });
    }

    function copyMeetingLink() {
        const url = `${window.location.origin}/meet/${meetingId}`;
        navigator.clipboard.writeText(url);
        showToast("Copied meeting link");
    }

    function showToast(msg, type = 'success') {
        const toast = document.createElement('div');
        let bgColor = 'bg-[#3c4043]';
        if (type === 'success') bgColor = 'bg-green-600';
        else if (type === 'error') bgColor = 'bg-red-600';
        else if (type === 'info') bgColor = 'bg-blue-600';

        toast.className = `p-4 rounded-lg shadow-lg text-sm font-medium animate-fade-in ${bgColor} text-white border border-gray-600 max-w-sm`;
        toast.textContent = msg;
        document.getElementById('toastContainer').appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function appendMessage(data) {
        const isMe = data.sid === socket.id;
        const div = document.createElement('div');
        div.className = `flex flex-col p-3 rounded-lg ${isMe ? 'bg-blue-600/20 border border-blue-500/30 ml-4' : 'bg-[#3c4043] border border-gray-600/30 mr-4'}`;
        div.innerHTML = `
            <div class="flex items-baseline gap-2 mb-1">
                <span class="text-sm font-semibold ${isMe ? 'text-blue-300' : 'text-white'}">${data.from}</span>
                <span class="text-[10px] text-gray-400">${new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}</span>
            </div>
            <p class="text-sm text-gray-100 leading-relaxed break-words">${escapeHtml(data.message)}</p>
        `;
        const container = document.getElementById('chatMessages');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;

        // Auto-open chat if not already open
        if (activeTab !== 'chat') {
            console.log('Opening chat automatically for new message');
            openTab('chat');
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function leaveCall() {
        const isHost = "{{ current_user_id }}" === "{{ meeting.host_id }}";

        if (isHost) {
            if (confirm("End meeting for everyone and generate AI summary?")) {
                showToast("Ending meeting and processing summary...", 'info');
                fetch(`/meet/${meetingId}/end`, { method: 'POST' })
                    .then(() => {
                        window.location.href = '/dashboard/summary_of_meetings'; // Redirect to summaries
                    })
                    .catch(e => {
                        console.error(e);
                        window.location.href = '/dashboard/';
                    });
                return;
            }
        }

        if (confirm("Leave this call?")) {
            window.location.href = '/dashboard/';
        }
    }

    document.getElementById('chatForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const inp = document.getElementById('chatInput');
        if (inp.value.trim()) {
            socket.emit('send_chat', { meetingId, message: inp.value.trim() });
            inp.value = '';
        }
    });

    init();
</script>
{% endblock %}